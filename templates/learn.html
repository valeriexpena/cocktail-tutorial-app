{% extends "base.html" %}

{% block title %}{{ cocktail_name }} - Step {{ step_id }}{% endblock %}

{% block content %}
<body class="learn-body">
  <h1 class="learn-title">How to Make {{ cocktail_name }}</h1>
  <h2>Step {{ step_id }}</h2>

  <div class="learn-flex-container">
    <div class="learn-flex-child">
      <p>{{ step_data["text_left"] }}</p>
      {% for img in step_data["media_left"] %}
        <img class="learn-img-large" src="/static/{{ img }}">
      {% endfor %}
    </div>

    <div class="learn-flex-child">
      <p>{{ step_data["text_right"] }}</p>

      <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
        {% for img in step_data["media_right"] %}
          {% set img_name = img.split('/')[-1] %}

          {% if "lemon_sliced" in img_name %}
            <img id="lemon-sliced" class="learn-img-small"
                 src="/static/{{ img }}" 
                 {% if step_id == "1" %}
                  style="display: none;">

              {% elif step_id == "9" %}
                 draggable="true"
                 ondragstart="handleDragStart(event)">
                 {% endif %}



          {% elif "lemon.png" == img_name %}
            <img id="lemon" class="learn-img-small"
                 src="/static/{{ img }}" ondragover="event.preventDefault()"
                 ondrop="handleDrop(event, 'lemon')">

          {% elif "knife" in img_name %}
            <img id="knife" class="learn-img-small"
                 src="/static/{{ img }}" draggable="true"
                 ondragstart="handleDragStart(event)">

          {% elif "ice_cube" in img_name %}
            <img id="ice-cube" class="learn-img-small"
                 src="/static/{{ img }}" draggable="true"
                 ondragstart="handleDragStart(event)">

          {% elif "shaker" in img_name %}
            <img id="shaker" class="learn-img-small"
                 src="/static/{{ img }}" 
                 {% if step_id == "6" %}
                   onmousedown="startShake(event)" 
                   onmouseup="stopShake()" 
                   onmouseleave="stopShake()"
                 {% elif step_id == "7" %}
                   draggable="true"
                   ondragstart="handleDragStart(event)"
                 {% else %}
                   ondragover="event.preventDefault()"
                   ondrop="handleDrop(event, 'shaker')"
                 {% endif %}>

          {% elif "glass" in img_name or "highball" in img_name %}
            <img id="glass" class="learn-img-small"
                 src="/static/{{ img }}" ondragover="event.preventDefault()"
                 ondrop="handleDrop(event, 'glass')">

          {% elif "vodka" in img_name or "tequila" in img_name or "triple_sec" in img_name or "whiskey" in img_name %}
            <img class="learn-img-small liquor-option"
                 src="/static/{{ img }}" onclick="handleLiquorClick(this)">

          {% elif "simple" in img_name %}
            <img id="simple" class="learn-img-small"
                 src="/static/{{ img }}" draggable="true"
                 ondragstart="handleDragStart(event)">

          {% elif "jigger" in img_name %}
            <img id="jigger" class="learn-img-small"
                 src="/static/{{ img }}" ondragover="event.preventDefault()"
                 ondrop="handleDrop(event, 'jigger')">

          {% elif "squeeze" in img_name %}
            <img id="squeeze" class="learn-img-small"
                 src="/static/{{ img }}" draggable="true"
                 ondragstart="handleDragStart(event)">

          {% elif "coke" in img_name %}
            <img id="coke" class="learn-img-small"
                 src="/static/{{ img }}" 
                 onclick="handleCokeClick()">

          {% elif "stir" in img_name %}
            <img id="stir" class="learn-img-small"
                 src="/static/{{ img }}" 
                 draggable="true"
                 ondragstart="handleDragStart(event)">

          {% elif "long_island_iced_tea_no_lemon" in img_name %}
            <img id="drink" class="learn-img-small"
                 src="/static/{{ img }}"
                 ondragover="event.preventDefault()"
                 ondrop="handleDrop(event, 'drink')">

          {% else %}
            <img class="learn-img-small" src="/static/{{ img }}">
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <div style="margin-top: 40px;">
    {% if prev_step_id is not none %}
      <a href="/cocktail/{{ drink_id }}/step/{{ prev_step_id }}">
        <button class="button-back">Back</button>
      </a>
    {% endif %}

    {% if next_step_id is not none %}
      <a href="/cocktail/{{ drink_id }}/step/{{ next_step_id }}" id="next-button" style="display: none;">
        <button class="button-next">Next</button>
      </a>
    {% endif %}
  </div>

  <script>
    function handleDragStart(event) {
      event.dataTransfer.setData("text/plain", event.target.id);
    }

    function handleDrop(event, target) {
      event.preventDefault();
      const draggedId = event.dataTransfer.getData("text/plain");

      // Lemon cutting
      if (draggedId === "knife" && target === "lemon") {
        document.getElementById("lemon").style.display = "none";
        document.getElementById("lemon-sliced").style.display = "inline";
        alert("Nice cut!");
        revealNext();
      }

      // Ice into shaker or glass
      if (draggedId === "ice-cube" && (target === "shaker" || target === "glass")) {
        alert(`Great! Ice added to the ${target}.`);
        revealNext();
      }

      // Step 4: Syrup to jigger for 2 seconds
      if (draggedId === "simple" && target === "jigger") {
        setTimeout(() => {
          alert("Syrup poured! Estimated 20ml.");
          revealNext();
        }, 2000);
      }

      // Step 5: Squeeze lemon (squeezer onto jigger)
      if (draggedId === "squeeze" && target === "jigger") {
        alert("Juiced into jigger!");
        revealNext();
      }

      // Step 7: Pour from shaker to glass
      if (draggedId === "shaker" && target === "glass") {
        alert("Drink poured into glass!");
        revealNext();
      }

      // Step 9: Stir and garnish
      if (target === "drink") {
        if (draggedId === "stir" && garnishStep === 0) {
          garnishStep = 1;
          alert("Drink stirred!");
        } else if (draggedId === "lemon-sliced" && garnishStep === 1) {
          alert("Lemon garnish added! Cocktail complete!");
          revealNext();
        }
      }
    }

    // Show next button
    function revealNext() {
      const nextBtn = document.getElementById("next-button");
      if (nextBtn) {
        nextBtn.style.display = "inline-block";
      }
    }

    // Shaker click
    document.addEventListener("DOMContentLoaded", function () {
      const shaker = document.getElementById("shaker");
      if (shaker) {
        shaker.addEventListener("click", function () {
          shaker.classList.add("shake");
          setTimeout(() => shaker.classList.remove("shake"), 500);
        });
      }
    });

    // Step 3 liquor selection
    const correctLiquors = ["vodka", "tequila", "triple_sec"];
    let selectedLiquors = [];

    function handleLiquorClick(img) {
      const name = img.src.split('/').pop().split('.')[0];
      if (correctLiquors.includes(name)) {
        if (!selectedLiquors.includes(name)) {
          selectedLiquors.push(name);
          img.style.border = "3px solid green";
        }
      } else {
        img.style.border = "3px solid red";
      }

      if (selectedLiquors.length === correctLiquors.length) {
        alert("Nice job! You added all the correct liquors.");
        revealNext();
      }
    }

    let shakeStartTime = null;
    let shakeTimer = null;

    function startShake(event) {
      shakeStartTime = Date.now();
      const shaker = event.target;
      shaker.classList.add("shake");
      
      shakeTimer = setInterval(() => {
        const shakeDuration = (Date.now() - shakeStartTime) / 1000;
        if (shakeDuration >= 6 && shakeDuration <= 8) {
          clearInterval(shakeTimer);
          shaker.classList.remove("shake");
          alert("Perfect shaking time!");
          revealNext();
        }
      }, 100);
    }

    function stopShake() {
      if (shakeTimer) {
        clearInterval(shakeTimer);
        shakeTimer = null;
      }
      const shaker = document.getElementById("shaker");
      if (shaker) {
        shaker.classList.remove("shake");
      }
      shakeStartTime = null;
    }

    function handleCokeClick() {
      alert("Coca-Cola added!");
      revealNext();
    }

    let garnishStep = 0;
  </script>

  <style>
    .shake {
      animation: shake 0.5s infinite;
    }

    @keyframes shake {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(5deg); }
      50% { transform: rotate(0deg); }
      75% { transform: rotate(-5deg); }
      100% { transform: rotate(0deg); }
    }
  </style>
</body>
{% endblock %}

